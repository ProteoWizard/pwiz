# TODO-20251019_utf8_no_bom.md

## Branch Information
- **Branch**: `Skyline/work/20251019_utf8_no_bom`
- **Created**: 2025-10-19
- **Objective**: Standardize all source files to UTF-8 without BOM

## Pull Request
**PR**: #3651
**Merged**: 2025-10-19
**Status**: Merged to master

## Background
Modern best practice is **UTF-8 without BOM** for source code. BOM can cause issues with:
- Unix/Linux build tools
- Git diffs and merges
- Some compilers and parsers
- Cross-platform compatibility

## Current State (Analysis Results - 2025-10-19)

**Analysis of 13,571 Git-tracked files:**
- **Total analyzed**: 13,562 files
- **Files WITH BOM**: 3,439 (25.36%)
- **Files WITHOUT BOM**: 10,123 (74.64%)
- **Binary/unreadable**: 0

**Files WITH BOM by extension:**
- `.cs`: 2,818 files (81.9% of BOM files)
- `.csproj`: 109 files
- `.view`: 100 files
- `.xsd`: 68 files
- `.sln`: 60 files
- `.sky`: 49 files
- `.config`: 35 files
- `.resx`: 35 files
- Other extensions: 165 files

**Key Findings:**
- C# source files (`.cs`) account for the vast majority of BOM usage
- Project/solution files also have BOM
- Some data files (`.sky`, `.view`) have BOM
- Complete list exported to `files-with-bom.txt` (3,439 files)

## Task Checklist

### Phase 1: Analysis
- [x] Run `analyze-bom-git.ps1` to get current statistics
- [x] Review `files-with-bom.txt` for complete file list
- [x] Identify any files that MUST keep BOM (if any)
- [x] Document current state in this TODO

**Files That Can Safely Have BOM Removed:**
- `.cs` files (2,818) - C# source code
- `.csproj`, `.sln` files (169) - MSBuild project files
- `.resx` files (35) - Resource files (XML-based)
- `.config` files (35) - Configuration files
- `.xsd`, `.xml` files (99) - XML schema and data files
- `.cpp` files (3) - C++ source code

**Files Requiring Special Consideration:**
- `.tli`, `.tlh` files (5) - Type library headers (auto-generated by Visual Studio from COM)
  - **Decision**: EXCLUDE - These are auto-generated by Visual Studio and should not be manually modified
- `.sky`, `.skyl`, `.skyr` files (54) - Skyline document files
  - **Decision**: SAFE TO CONVERT - These are XML-based Skyline documents
- `.view` files (100) - Skyline view configuration files
  - **Decision**: SAFE TO CONVERT - These are also XML-based

**Files to EXCLUDE from BOM removal:**
- Auto-generated COM type library files: `*.tli`, `*.tlh` (5 files)
  - These are regenerated by Visual Studio and should match IDE output

**Summary:**
- **Files to convert**: 3,434 files
- **Files to exclude**: 5 files (.tli/.tlh)

### Phase 2: Tooling
- [x] Create `remove-bom.ps1` script to strip BOM from files
- [x] Test script on small subset of files
- [x] Verify Git diff shows only BOM removal (no content changes)

### Phase 3: Conversion
- [x] Create test branch and convert subset of files
- [x] Build and run tests to verify no regressions
- [x] Visual Studio verification - files open correctly
- [x] Convert all remaining files (3,434 files converted)
- [x] Run full test suite on all platforms (TeamCity tests passed)

### Phase 4: Prevention
- [x] Add `.editorconfig` with `charset = utf-8` to prevent future BOMs
- [x] Add BOM check to CodeInspectionTest.cs (Skyline-specific)
  - Added `InspectUtf8Bom()` method
  - Automatically removes BOM and fails test to alert developers
  - Excludes auto-generated files: `*.tli`, `*.tlh`
  - Excludes bin/, obj/, and Git submodule directories
- [x] Add `Encoding.UTF8` detection to CodeInspectionTest.cs
  - Prevents use of `Encoding.UTF8` with file-writing operations
  - Forces explicit use of `new UTF8Encoding(false)` or `new UTF8Encoding(true)`
- [x] Fix root cause: Changed 10 instances of `Encoding.UTF8` to `new UTF8Encoding(false)`
  - 6 `XmlTextWriter` instances (SrmDocument.cs, AuditLogEntry.cs, etc.)
  - 2 `File.WriteAllText` instances
  - 1 `DockPanel.SaveAsXml` instance
  - 1 `StreamWriter` instance
- [x] Restore BOMs to 6 vendor test data XML files (Agilent instrument format requires BOM)
- [x] Update this TODO with final statistics

### Phase 5: Cleanup
- [x] Move TODO file to `todos/completed/` before merging
- [x] Keep analysis and validation scripts for future use

## Tools & Scripts
- **`scripts/misc/analyze-bom-git.ps1`** - Analysis script (keep permanently)
  - Now accepts optional `-OutputFile` parameter
  - No longer creates files-with-bom.txt at root by default
- **`scripts/misc/remove-bom.ps1`** - BOM removal script (keep permanently)
- **`scripts/misc/validate-bom-compliance.ps1`** - Validation script (keep permanently)
  - Checks against approved list of 11 files allowed to have BOM
  - Returns exit code 0 if compliant, 1 if unexpected BOMs found
  - Ready for use in CI or commit hooks
- **`todos/completed/original-files-with-bom.txt`** - Original list of 3,439 files with BOM (historical record)

## Risks & Considerations
- **Large commit**: May affect hundreds of files
- **Merge conflicts**: Active branches will need coordination
- **Third-party tools**: Some Windows tools default to UTF-8 with BOM
- **Localization**: Verify `.resx` files handle encoding correctly
- **Timing**: Coordinate with team to minimize disruption

## Final Results (2025-10-20)

**Successfully completed!** ✅

### What Was Accomplished
- **Removed BOMs from 3,434 source files** (96.2% were pure ASCII, BOM unnecessary)
- **Preserved BOMs on 11 approved files**:
  - 5 Visual Studio auto-generated COM type library files (.tli/.tlh)
  - 6 Agilent vendor data format test files (.d directories)
- **Fixed root cause**: Changed 10 code locations using `Encoding.UTF8` to explicit `new UTF8Encoding(false)`
- **Added prevention**: `.editorconfig` + CodeInspectionTest checks prevent BOM reintroduction
- **All tests passed**: TeamCity CI, Skyline builds, Visual Studio verification

### Character Encoding Analysis
Analysis of original 3,439 files with BOM revealed:
- **96.2% (3,308 files)**: Pure ASCII (0-127) - BOM completely unnecessary
- **3.8% (131 files)**: Extended ASCII (128-255) - might need encoding declaration
- **0% (0 files)**: Unicode characters (>255) - none required UTF-8

**Conclusion**: Vast majority of BOMs served no purpose; added by Visual Studio default behavior.

### Prevention Mechanisms
1. **`.editorconfig`**: Project-wide `charset = utf-8` prevents Visual Studio from adding BOMs
2. **CodeInspectionTest.cs**: Skyline-specific automated BOM detection and removal with test failure
3. **Encoding.UTF8 ban**: Code inspection prevents problematic `Encoding.UTF8` usage
4. **Validation script**: `validate-bom-compliance.ps1` checks against approved 11-file list

### Success Criteria - All Met ✅
- ✅ All source files standardized to UTF-8 without BOM (except 11 approved)
- ✅ No build or test failures
- ✅ Guidelines prevent regression (`.editorconfig` + tests)
- ✅ Analysis script confirms BOM-free status

## Future Work: CI Integration (Out of Scope for Current Branch)

The `validate-bom-compliance.ps1` script is ready for CI integration but requires significant additional work:

**Key Challenge: Cross-Platform Compatibility**
- ProteoWizard builds on Windows, Linux, and macOS (hence Boost.Build)
- Current validation script is PowerShell (Windows-only)
- Any CI integration must work across all three platforms
- Commit hooks must be cross-platform (bash scripts work everywhere, PowerShell doesn't)
- This complexity is why we defer to future work with proper planning

Current script provides immediate value for Windows development (where most Skyline work happens), but ProteoWizard-level CI integration requires a proper cross-platform solution.

Consider for future TODO:

### Option 1: Boost.Build/Jam Integration
Add BOM validation test to pwiz test suite (runs on TeamCity alongside Reader_Agilent_Test, etc.):
- Create C++ wrapper executable: `scripts/misc/bom-validation-test.cpp`
  - Calls PowerShell script via `std::system()`
  - Returns proper exit codes (0 = pass, 1 = fail)
- Add to appropriate Jamfile.jam (likely `pwiz/utility/misc/Jamfile.jam` or root `Jamroot.jam`)
  - Use `run-if-exists` rule for Windows-only execution
  - Example: `run-if-exists bom-validation-test.cpp : : : : bom-validation-test ;`
- Requires coordination with Boost.Build expert (Matt)

### Option 2: Git Commit Hook
Simpler alternative for immediate protection:
- Create `.githooks/pre-commit` template with setup instructions
- Developers opt-in by running: `git config core.hooksPath .githooks`
- **Challenge**: Hook must work on Windows, Linux, and macOS
  - Would need bash script that detects platform
  - Calls PowerShell on Windows, needs alternate implementation on Unix
  - Still requires cross-platform solution

### Option 3: GitHub Actions / CI Script
If project moves to GitHub Actions or similar:
- Add BOM validation as separate CI job
- Runs on every PR
- Fails PR if unexpected BOMs found

**Recommendation**: All options require cross-platform solution. Best approach:
1. Document the requirement clearly (this TODO)
2. Create a separate TODO for cross-platform CI integration
3. Coordinate with Matt (Boost.Build expert) for proper implementation
4. Consider Python-based solution (works everywhere) instead of PowerShell/bash

For now, the validation script provides value for manual Windows-based verification and documents the approved BOM list.

## Handoff Prompt for Branch Creation

```
I want to start work on UTF-8 BOM standardization.

Please:
1. Create branch: Skyline/work/YYYYMMDD_utf8_no_bom (use today's date)
2. Rename TODO-utf8_no_bom.md to TODO-YYYYMMDD_utf8_no_bom.md
3. Run .\analyze-bom-git.ps1 and update the TODO with current statistics
4. Begin Phase 1: Analysis

The TODO file contains full context. Let's start by understanding the current state of BOM usage.
```